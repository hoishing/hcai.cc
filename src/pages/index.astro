---
import BaseLayout from "../layouts/BaseLayout.astro";
import PostCard from "../components/PostCard.astro";
import ToolCard from "../components/ToolCard.astro";
import CardGrid from "../components/CardGrid.astro";
import { getCollection } from "astro:content";

const collectionPathMap: Record<string, string> = {
  astrology: "/astrology/",
  psychology: "/psychology/",
  mbti: "/mbti/",
  tarot: "/tarot/",
};

const allPosts = [
  ...(await getCollection("astrology", ({ data }) => !data.draft)),
  ...(await getCollection("psychology", ({ data }) => !data.draft)),
  ...(await getCollection("mbti", ({ data }) => !data.draft)),
  ...(await getCollection("tarot", ({ data }) => !data.draft)),
];
allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const recentPosts = allPosts.slice(0, 6);

const tools = await getCollection("tools");

function getPostHref(post: (typeof allPosts)[0]) {
  const base = collectionPathMap[post.collection] || "/";
  return `${base}${post.id}`;
}
---

<BaseLayout title="首頁">
  <section class="mb-12">
    <h2 class="text-2xl font-bold mb-6">最新文章</h2>
    {
      recentPosts.length === 0 ? (
        <p class="text-base-content/60">尚無文章，敬請期待。</p>
      ) : (
        <CardGrid>
          {recentPosts.map((post) => (
            <PostCard
              title={post.data.title}
              description={post.data.description}
              pubDate={post.data.pubDate}
              href={getPostHref(post)}
              heroImage={post.data.heroImage}
              tags={post.data.tags}
            />
          ))}
        </CardGrid>
      )
    }
  </section>

  <section>
    <h2 class="text-2xl font-bold mb-6">小工具</h2>
    <CardGrid>
      {
        tools.map((tool) => (
          <ToolCard
            name={tool.data.name}
            description={tool.data.description}
            url={tool.data.url}
            icon={tool.data.icon}
          />
        ))
      }
    </CardGrid>
  </section>
</BaseLayout>
